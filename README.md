# FHIR R4 vs R6 Comparison Scripts

This directory (`comparison/`) contains the core scripts for fetching FHIR resource definitions from official sources and leveraging AI (Google Gemini) to analyze and compare R4 and R6 versions.

## Prerequisites

1.  **Bun Runtime**: These scripts are written in TypeScript and designed to be run with Bun. Installation instructions: [https://bun.sh/docs/installation](https://bun.sh/docs/installation)
2.  **Google Gemini API Key**: You need an API key for Google Gemini for the `generate_resource_summaries.ts` and `analyze_difference.ts` scripts.
    *   The scripts require the `GEMINI_API_KEY` environment variable to be set.
    *   **Methods to set the API key** (assuming you run commands from the project root, where a `.env` file would be typically located):
        1.  **Directly in the shell (for the current session):**
            ```bash
            export GEMINI_API_KEY="YOUR_API_KEY_HERE"
            ```
        2.  **Using a `.env` file:** Create a file named `.env` in your project's root directory with the content:
            ```env
            GEMINI_API_KEY="YOUR_API_KEY_HERE"
            ```
            Bun automatically loads `.env` files. Ensure this file is in your `.gitignore`.
        3.  **Prefixing the command (for a single run from project root):**
            ```bash
            GEMINI_API_KEY="YOUR_API_KEY_HERE" bun run comparison/script_name.ts <ResourceName>
            ```

## Directory Structure for Outputs

When run (typically from the project root), these scripts will generate output in the following directories relative to the execution directory:
-   `r4/`: Stores fetched HTML excerpts for R4 resources (e.g., `r4/patient.html`).
-   `r6/`: Stores fetched HTML excerpts for R6/build resources (e.g., `r6/patient.html`).
-   `analyzed/`: Contains markdown files generated by Gemini.
    -   `analyzed/r4/<ResourceName>.md`: Gemini's structured view of the R4 resource.
    -   `analyzed/r6/<ResourceName>.md`: Gemini's structured view of the R6 resource.
    -   `analyzed/diff/<ResourceName>.md`: Gemini's analysis of the differences between R4 and R6.

Example/template files used by these scripts are located within `comparison/examples/`.

## Scripts Overview & Usage

All scripts are designed to be invoked from the **project root directory**.

1.  **`generate_fhir_doc.ts`**:
    *   **Purpose**: Fetches HTML content for a specified FHIR resource from hl7.org (R4) and build.fhir.org (R6/current build).
    *   **Output**: Saves relevant HTML segments to `r4/<ResourceName>.html` and `r6/<ResourceName>.html`.
    *   **Usage** (from project root):
        ```bash
        bun run comparison/generate_fhir_doc.ts <ResourceName>
        ```

2.  **`generate_resource_summaries.ts`**:
    *   **Purpose**: Takes the HTML files generated by `generate_fhir_doc.ts` and uses Gemini to create structured markdown summaries for both the R4 and R6 versions of the resource. It uses `comparison/examples/summarize.txt` as a template for the prompt.
    *   **Requires**: `GEMINI_API_KEY` to be set. Input HTML files from `generate_fhir_doc.ts`.
    *   **Output**: Saves markdown files to `analyzed/r4/<ResourceName>.md` and `analyzed/r6/<ResourceName>.md`.
    *   **Usage** (from project root):
        ```bash
        bun run comparison/generate_resource_summaries.ts <ResourceName>
        ```

3.  **`analyze_difference.ts`**:
    *   **Purpose**: Takes the R4 and R6 markdown summaries generated by `generate_resource_summaries.ts` and uses Gemini to perform a detailed difference analysis. It uses `comparison/examples/patient_diff_example.md` to guide the AI on the desired output format and focus.
    *   **Requires**: `GEMINI_API_KEY` to be set. Input markdown summary files from `generate_resource_summaries.ts`.
    *   **Output**: Saves a markdown difference report to `analyzed/diff/<ResourceName>.md`.
    *   **Usage** (from project root):
        ```bash
        bun run comparison/analyze_difference.ts <ResourceName>
        ```

4.  **`fetch_us_core.ts`**:
    *   **Purpose**: Contains a hardcoded list of US Core FHIR resource names (`usCoreResourceNames`). This list is primarily intended for use by an orchestrator script (like `run_fhir_comparison.ts` in the project root). It can also be run independently to execute *only* the `generate_fhir_doc.ts` step for all listed US Core resources.
    *   **Usage** (from project root, for generating only HTML docs for US Core):
        ```bash
        bun run comparison/fetch_us_core.ts
        ```

## Running an Automated Workflow

While the scripts above can be run individually, they are designed to be part of a larger automated workflow. An orchestrator script, such as `run_fhir_comparison.ts` (expected to be in the project root), would typically call these scripts in sequence for a list of resources.

Example command for such an orchestrator (if `run_fhir_comparison.ts` is in the project root):
```bash
bun run run_fhir_comparison.ts
```
This orchestrator handles initializing the Gemini AI client and calling the `ensure<Output>` functions exported by the scripts in this directory, managing the dependency chain and skipping already completed steps.

## Note on Script Design

Each primary script (`generate_fhir_doc.ts`, `generate_resource_summaries.ts`, `analyze_difference.ts`) exports an `async` function (e.g., `ensureFhirDocHtml`) that contains its core logic. These functions are designed to be idempotent: they check if their target output files exist and skip execution if they do. They also handle their own dependencies by calling the respective `ensure...` functions from other scripts. This allows for a resilient and efficient pipeline, especially when processing many resources.

When run directly via CLI (e.g., `bun run comparison/generate_fhir_doc.ts Patient`), the `main` function within each script calls its respective `ensure...` function, making them usable both as standalone tools and as modules in a larger system.
